name: Build and Deploy Serenity Report to GitHub Pages

on:
  push:
    branches:
      - main  # Cambia 'main' por la rama principal de tu repositorio si es diferente.
      - Stage

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Verificar que el código esté correcto en la rama principal
      - name: Checkout code
        uses: actions/checkout@v2

      # Paso 2: Configurar Java (especificar distribución, por ejemplo 'adoptopenjdk')
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adoptopenjdk'  # Aquí especificamos la distribución

      # Paso 3: Verificar si la carpeta de Serenity Report existe
      - name: List build directory
        run: ls -R ./build

      # Paso 4: Ejecutar las pruebas de Serenity
      - name: Run Gradle build
        run: ./gradlew build

      # Paso 5: Subir el reporte a GitHub Pages
      - name: Upload Serenity Report to GitHub Pages
        if: success()  # Solo se ejecuta si el paso anterior fue exitoso
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # Usando el token de GitHub
          publish_dir: ./build/serenity-report  # Ruta del directorio con el reporte generado

      # Paso 6: Configuración para la rama gh-pages
      - name: Create gh-pages branch if not exists
        run: |
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git reset --hard
          git add -A
          git commit -m "Deploy Serenity Report"
          git push origin gh-pages
